<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FourLetterCommands.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">parent$MyZookeeperRemoveWatchesTest.exec</a> &gt; <a href="index.source.html" class="el_package">org.apache.zookeeper.server.command</a> &gt; <span class="el_source">FourLetterCommands.java</span></div><h1>FourLetterCommands.java</h1><pre class="source lang-java linenums">/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.apache.zookeeper.server.command;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.nio.ByteBuffer;
import java.util.HashMap;
import java.util.Map;
import java.util.HashSet;
import java.util.Set;
import java.util.Arrays;

/**
 * This class contains constants for all the four letter commands
 */
<span class="nc" id="L34">public class FourLetterCommands {</span>
    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L39">    public final static int confCmd =</span>
<span class="fc" id="L40">        ByteBuffer.wrap(&quot;conf&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L46">    public final static int consCmd =</span>
<span class="fc" id="L47">        ByteBuffer.wrap(&quot;cons&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L53">    public final static int crstCmd =</span>
<span class="fc" id="L54">        ByteBuffer.wrap(&quot;crst&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L60">    public final static int dirsCmd =</span>
<span class="fc" id="L61">        ByteBuffer.wrap(&quot;dirs&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L67">    public final static int dumpCmd =</span>
<span class="fc" id="L68">        ByteBuffer.wrap(&quot;dump&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L74">    public final static int enviCmd =</span>
<span class="fc" id="L75">        ByteBuffer.wrap(&quot;envi&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L81">    public final static int getTraceMaskCmd =</span>
<span class="fc" id="L82">        ByteBuffer.wrap(&quot;gtmk&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L88">    public final static int ruokCmd =</span>
<span class="fc" id="L89">        ByteBuffer.wrap(&quot;ruok&quot;.getBytes()).getInt();</span>
    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L94">    public final static int setTraceMaskCmd =</span>
<span class="fc" id="L95">        ByteBuffer.wrap(&quot;stmk&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L101">    public final static int srvrCmd =</span>
<span class="fc" id="L102">        ByteBuffer.wrap(&quot;srvr&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L108">    public final static int srstCmd =</span>
<span class="fc" id="L109">        ByteBuffer.wrap(&quot;srst&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L115">    public final static int statCmd =</span>
<span class="fc" id="L116">        ByteBuffer.wrap(&quot;stat&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L122">    public final static int wchcCmd =</span>
<span class="fc" id="L123">        ByteBuffer.wrap(&quot;wchc&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L129">    public final static int wchpCmd =</span>
<span class="fc" id="L130">        ByteBuffer.wrap(&quot;wchp&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L136">    public final static int wchsCmd =</span>
<span class="fc" id="L137">        ByteBuffer.wrap(&quot;wchs&quot;.getBytes()).getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L143">    public final static int mntrCmd = ByteBuffer.wrap(&quot;mntr&quot;.getBytes())</span>
<span class="fc" id="L144">            .getInt();</span>

    /*
     * See &lt;a href=&quot;{@docRoot}/../../../docs/zookeeperAdmin.html#sc_zkCommands&quot;&gt;
     * Zk Admin&lt;/a&gt;. this link is for all the commands.
     */
<span class="fc" id="L150">    public final static int isroCmd = ByteBuffer.wrap(&quot;isro&quot;.getBytes())</span>
<span class="fc" id="L151">            .getInt();</span>

    /*
     * The control sequence sent by the telnet program when it closes a
     * connection. Include simply to keep the logs cleaner (the server would
     * close the connection anyway because it would parse this as a negative
     * length).
     */
    public final static int telnetCloseCmd = 0xfff4fffd;

    private static final String ZOOKEEPER_4LW_COMMANDS_WHITELIST = &quot;zookeeper.4lw.commands.whitelist&quot;;

<span class="fc" id="L163">    private static final Logger LOG = LoggerFactory.getLogger(FourLetterCommands.class);</span>

<span class="fc" id="L165">    private static final Map&lt;Integer, String&gt; cmd2String = new HashMap&lt;Integer, String&gt;();</span>

<span class="fc" id="L167">    private static final Set&lt;String&gt; whiteListedCommands = new HashSet&lt;String&gt;();</span>

<span class="fc" id="L169">    private static boolean whiteListInitialized = false;</span>

    // @VisibleForTesting
    public synchronized static void resetWhiteList() {
<span class="nc" id="L173">        whiteListInitialized = false;</span>
<span class="nc" id="L174">        whiteListedCommands.clear();</span>
<span class="nc" id="L175">    }</span>

    /**
     * Return the string representation of the specified command code.
     */
    public static String getCommandString(int command) {
<span class="fc" id="L181">        return cmd2String.get(command);</span>
    }

    /**
     * Check if the specified command code is from a known command.
     *
     * @param command The integer code of command.
     * @return true if the specified command is known, false otherwise.
     */
    public static boolean isKnown(int command) {
<span class="fc" id="L191">        return cmd2String.containsKey(command);</span>
    }

    /**
     * Check if the specified command is enabled.
     *
     * In ZOOKEEPER-2693 we introduce a configuration option to only
     * allow a specific set of white listed commands to execute.
     * A command will only be executed if it is also configured
     * in the white list.
     *
     * @param command The command string.
     * @return true if the specified command is enabled
     */
    public synchronized static boolean isEnabled(String command) {
<span class="fc bfc" id="L206" title="All 2 branches covered.">        if (whiteListInitialized) {</span>
<span class="fc" id="L207">            return whiteListedCommands.contains(command);</span>
        }

<span class="fc" id="L210">        String commands = System.getProperty(ZOOKEEPER_4LW_COMMANDS_WHITELIST);</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (commands != null) {</span>
<span class="fc" id="L212">            String[] list = commands.split(&quot;,&quot;);</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">            for (String cmd : list) {</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">                if (cmd.trim().equals(&quot;*&quot;)) {</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">                    for (Map.Entry&lt;Integer, String&gt; entry : cmd2String.entrySet()) {</span>
<span class="fc" id="L216">                        whiteListedCommands.add(entry.getValue());</span>
<span class="fc" id="L217">                    }</span>
<span class="fc" id="L218">                    break;</span>
                }
<span class="nc bnc" id="L220" title="All 2 branches missed.">                if (!cmd.trim().isEmpty()) {</span>
<span class="nc" id="L221">                    whiteListedCommands.add(cmd.trim());</span>
                }
            }
        }

        // It is sad that isro and srvr are used by ZooKeeper itself. Need fix this
        // before deprecating 4lw.
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">        if (System.getProperty(&quot;readonlymode.enabled&quot;, &quot;false&quot;).equals(&quot;true&quot;)) {</span>
<span class="nc" id="L229">            whiteListedCommands.add(&quot;isro&quot;);</span>
        }
        // zkServer.sh depends on &quot;srvr&quot;.
<span class="fc" id="L232">        whiteListedCommands.add(&quot;srvr&quot;);</span>
<span class="fc" id="L233">        whiteListInitialized = true;</span>
<span class="fc" id="L234">        LOG.info(&quot;The list of known four letter word commands is : {}&quot;, Arrays.asList(cmd2String));</span>
<span class="fc" id="L235">        LOG.info(&quot;The list of enabled four letter word commands is : {}&quot;, Arrays.asList(whiteListedCommands));</span>
<span class="fc" id="L236">        return whiteListedCommands.contains(command);</span>
    }

    // specify all of the commands that are available
    static {
<span class="fc" id="L241">        cmd2String.put(confCmd, &quot;conf&quot;);</span>
<span class="fc" id="L242">        cmd2String.put(consCmd, &quot;cons&quot;);</span>
<span class="fc" id="L243">        cmd2String.put(crstCmd, &quot;crst&quot;);</span>
<span class="fc" id="L244">        cmd2String.put(dirsCmd, &quot;dirs&quot;);</span>
<span class="fc" id="L245">        cmd2String.put(dumpCmd, &quot;dump&quot;);</span>
<span class="fc" id="L246">        cmd2String.put(enviCmd, &quot;envi&quot;);</span>
<span class="fc" id="L247">        cmd2String.put(getTraceMaskCmd, &quot;gtmk&quot;);</span>
<span class="fc" id="L248">        cmd2String.put(ruokCmd, &quot;ruok&quot;);</span>
<span class="fc" id="L249">        cmd2String.put(setTraceMaskCmd, &quot;stmk&quot;);</span>
<span class="fc" id="L250">        cmd2String.put(srstCmd, &quot;srst&quot;);</span>
<span class="fc" id="L251">        cmd2String.put(srvrCmd, &quot;srvr&quot;);</span>
<span class="fc" id="L252">        cmd2String.put(statCmd, &quot;stat&quot;);</span>
<span class="fc" id="L253">        cmd2String.put(wchcCmd, &quot;wchc&quot;);</span>
<span class="fc" id="L254">        cmd2String.put(wchpCmd, &quot;wchp&quot;);</span>
<span class="fc" id="L255">        cmd2String.put(wchsCmd, &quot;wchs&quot;);</span>
<span class="fc" id="L256">        cmd2String.put(mntrCmd, &quot;mntr&quot;);</span>
<span class="fc" id="L257">        cmd2String.put(isroCmd, &quot;isro&quot;);</span>
<span class="fc" id="L258">        cmd2String.put(telnetCloseCmd, &quot;telnet close&quot;);</span>
<span class="fc" id="L259">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>